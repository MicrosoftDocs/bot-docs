---
title: Add telemetry to your bot | Microsoft Docs
description: Learn how to integrate your bot with the new telemetry features.
keywords: telemetry, appinsights, monitor bot
author: ivorb
ms.author: v-ivorb
manager: kamrani
ms.topic: article
ms.service: bot-service
ms.subservice: sdk
ms.date: 02/06/2019
monikerRange: 'azure-bot-service-4.0'
---

# Add telemetry to your bot

[!INCLUDE[applies-to](../includes/applies-to.md)]

In version 4.2 of the Bot Framework SDK, telemetry logging was added into the product.  This enables bot applications to send event data to services such as Application Insights.

This document covers how to integrate your bot with the new telemetry features.  

## Using Bot Configuration (Option 1 of 2)
There are two methods of configuring your bot.  The first assumes you are integrating with Application Insights.

The bot configuration file contains metadata about external services the Bot uses while running.  For example, CosmosDB, Application Insights and the Language Understanding (LUIS) service connection and metadata is stored here.   

If you want "stock" Application Insights, with no additional Application Insights-specific configuration required (for example Telemetry Initializers), pass in the bot configuration object during initialization.   This is the easiest method to initialize and will configure Application Insights to begin tracking Requests, external calls to other services, and correlating events across services.

```csharp
// ASP.Net Core - Startup.cs

public void ConfigureServices(IServiceCollection services)
{
     ...
     // Add Application Insights - pass in the bot configuration
     services.AddBotApplicationInsights(botConfig);
     ...
}

public void Configure(IApplicationBuilder app, IHostingEnvironment env)
{
     app.UseBotApplicationInsights()
                 ...
                .UseDefaultFiles()
                .UseStaticFiles()
                .UseBotFramework();
                ...
}
```

```JavaScript
const appInsightsClient = new ApplicationInsightsTelemetryClient(botConfig);
```

**No Application Insights in Bot Configuration**
What if your bot configuration doesn't contain Application Insights?  No problem, it defaults to a null client which no-ops the method calls.

**Multiple Application Insights**
Have multiple Application Insight sections in your bot configuration?  You can designate which instance of the Application Insights service you want to use inside your bot configuration.

```csharp
// ASP.Net Core - Startup.cs

public void ConfigureServices(IServiceCollection services)
{
     // Add Application Insights
     services.AddBotApplicationInsights(botConfig, "myAppInsights");
     ...
}
```

```JavaScript
const appInsightsClient = new ApplicationInsightsTelemetryClient(botConfig);
```

## Overriding the Telemetry Client (Option 2 of 2)

If you want to customize your Application Insights client, or you want to log into a completely separate service, you have to configure the system differently.

**Modify Application Insights Configuration**

```csharp

public void ConfigureServices(IServiceCollection services)
{
     ...
     // Create Application Insight Telemetry Client
     // with custom configuration.
     var telemetryClient = TelemetryClient(myCustomConfiguration)
     
     // Add Application Insights
     services.AddBotApplicationInsights(new BotTelemetryClient(telemetryClient), "InstrumentationKey");
```

```JavaScript
const appInsightsClient = new ApplicationInsightsTelemetryClient(botConfig);
```

**Use Custom Telemetry**
If you want to log telemetry events generated by the Bot Framework into a completely separate system, create a new class derived from the base interface and configure.  

```csharp
public void ConfigureServices(IServiceCollection services)
{
     ...
     // Create my IBotTelemetryClient-based logger
     var myTelemetryClient = MyTelemetryLogger();
     
     // Add Application Insights
     services.AddBotApplicationInsights(myTelemetryClient);
     ...
}
```

```JavaScript
const appInsightsClient = new ApplicationInsightsTelemetryClient(botConfig);
```

## Add custom logging to your bot

Once the Bot has the new telemetry logging support configured, you can begin adding telemetry to your bot.  The `BotTelemetryClient`(in C#, `IBotTelemetryClient`) has several methods to log distinct types of events.  Choosing the appropriate type of event enables you to take advantage of Application Insights existing reports (if you are using Application Insights).  For general scenarios `TraceEvent` is typically used.  The data logged using `TraceEvent` lands in the `CustomEvent` table in Kusto.

If using a Dialog within your Bot, every Dialog-based object (including Prompts) will contain a new `TelemetryClient` property.  This is the `BotTelemetryClient` that enables you to perform logging.  This is not just a convenience, we'll see later in this article if this property is set, `WaterfallDialogs` will generate events.

### Identifiers and Custom Events

When logging events into Application Insights, the events generated contain default properties that you won't have to fill.  For example, `user_id` and `session_id`properties are contained in each Custom Event (generated with the `TraceEvent` API).  In addition, `activitiId`, `activityType` and `channelId` are also added.

>Note: Custom telemetry clients will not be provided these values.

Property |Type | Details
--- | --- | ---
`user_id`| `string` | [ChannelID](https://github.com/Microsoft/botframework-obi/blob/master/botframework-activity/botframework-activity.md#channel-id) + [From.Id](https://github.com/Microsoft/botframework-obi/blob/master/botframework-activity/botframework-activity.md#from)
`session_id`| `string`|  [ConversationID](https://github.com/Microsoft/botframework-obi/blob/master/botframework-activity/botframework-activity.md#conversation)
`customDimensions.activityId`| `string` | [The bot activity ID](https://github.com/Microsoft/botframework-obi/blob/master/botframework-activity/botframework-activity.md#id)
`customDimensions.activityType` | `string` | [The bot activity type ](https://github.com/Microsoft/botframework-obi/blob/master/botframework-activity/botframework-activity.md#channel-id)
`customDimensions.channelId` | `string` |  [The bot activity channel ID ](https://github.com/Microsoft/botframework-obi/blob/master/botframework-activity/botframework-activity.md#channel-id)

## WaterfallDialog events

In addition  to generating your own events, the `WaterfallDialog` object within the SDK now generates events. The following section describes the events generated from within the Bot Framework. By setting the `TelemetryClient` property on the `WaterfallDialog` these events will be stored.

Here's an example of modifying a sample (BasicBot) which employs the `WaterfallDialog`, to log telemetry events.  BasicBot employs a common pattern used where a `WaterfallDialog` is placed within a `ComponentDialog` (`GreetingDialog`).

```csharp
// IBotTelemetryClient is direct injected into our Bot
public BasicBot(BotServices services, UserState userState, ConversationState conversationState, IBotTelemetryClient telemetryClient)
...

// The IBotTelemetryClient passed to the GreetingDialog
...
Dialogs = new DialogSet(_dialogStateAccessor);
Dialogs.Add(new GreetingDialog(_greetingStateAccessor, telemetryClient));
...

// The IBotTelemetryClient to the WaterfallDialog
...
AddDialog(new WaterfallDialog(ProfileDialog, waterfallSteps) { TelemetryClient = telemetryClient });
...

```

Once the `WaterfallDialog` has a configured `IBotTelemetryClient`, it will begin logging events.

### CustomEvent: "WaterfallStart" 

When a WaterfallDialog begins, a `WaterfallStart` event is logged.

- `user_id`  ([From Telemetry Initializer](https://aka.ms/telemetry-initializer))
- `session_id` ([From Telemetry Initializer](https://aka.ms/telemetry-initializer))
- `customDimensions.activityId`  ([From Telemetry Initializer](https://aka.ms/telemetry-initializer))
- `customDimensions.activityType`  ([From Telemetry Initializer](https://aka.ms/telemetry-initializer))
- `customDimensions.channelId` ([From Telemetry Initializer](https://aka.ms/telemetry-initializer))
- `customDimensions.DialogId` (This is the dialogId (string) passed into your Waterfall.  You can consider this the "waterfall type")
- `customDimensions.InstanceID` (unique per instance of the dialog)

### CustomEvent: "WaterfallStep" 

Logs individual steps from a Waterfall Dialog.

- `user_id`  ([From Telemetry Initializer](https://aka.ms/telemetry-initializer))
- `session_id` ([From Telemetry Initializer](https://aka.ms/telemetry-initializer))
- `customDimensions.activityId`  ([From Telemetry Initializer](https://aka.ms/telemetry-initializer))
- `customDimensions.activityType`  ([From Telemetry Initializer](https://aka.ms/telemetry-initializer))
- `customDimensions.channelId` ([From Telemetry Initializer](https://aka.ms/telemetry-initializer))
- `customDimensions.DialogId` (This is the dialogId (string) passed into your Waterfall.  You can consider this the "waterfall type")
- `customDimensions.StepName` (either method name or `StepXofY` if lambda)
- `customDimensions.InstanceID` (unique per instance of the dialog)

### CustomEvent: "WaterfallDialogComplete"

Logs when a Waterfall Dialog completes.

- `user_id`  ([From Telemetry Initializer](https://aka.ms/telemetry-initializer))
- `session_id` ([From Telemetry Initializer](https://aka.ms/telemetry-initializer))
- `customDimensions.activityId`  ([From Telemetry Initializer](https://aka.ms/telemetry-initializer))
- `customDimensions.activityType`  ([From Telemetry Initializer](https://aka.ms/telemetry-initializer))
- `customDimensions.channelId` ([From Telemetry Initializer](https://aka.ms/telemetry-initializer))
- `customDimensions.DialogId` (This is the dialogId (string) passed into your Waterfall.  You can consider this the "waterfall type")
- `customDimensions.InstanceID` (unique per instance of the dialog)

### CustomEvent: "WaterfallDialogCancel" 

Logs when a Waterfall Dialog is canceled.

- `user_id`  ([From Telemetry Initializer](https://aka.ms/telemetry-initializer))
- `session_id` ([From Telemetry Initializer](https://aka.ms/telemetry-initializer))
- `customDimensions.activityId`  ([From Telemetry Initializer](https://aka.ms/telemetry-initializer))
- `customDimensions.activityType`  ([From Telemetry Initializer](https://aka.ms/telemetry-initializer))
- `customDimensions.channelId` ([From Telemetry Initializer](https://aka.ms/telemetry-initializer))
- `customDimensions.DialogId` (This is the dialogId (string) passed into your Waterfall.  You can consider this the "waterfall type")
- `customDimensions.StepName` (either method name or `StepXofY` if lambda)
- `customDimensions.InstanceID` (unique per instance of the dialog)


## Events generated by the Bot Framework Service

In addition to `WaterfallDialog`, which generates events from your bot code, the Bot Framework Channel service also logs events.  This helps you diagnose issues with Channels or overall bot failures.

### CustomEvent: "Activity"
**Logged From:** Channel Service
Logged by the Channel Service when a message received.

### Exception: "Bot Errors"
**Logged From:** Channel Service
Logged by the channel when a call to the Bot returns a non-2XX Http Response.

## Additional Events

The [Enterprise Template](https://github.com/Microsoft/AI/tree/master/templates/Enterprise-Template) is open source code that can be freely copied.  This contains several components that can be reused and modified to suit your reporting needs.

### CustomEvent: BotMessageReceived 
**Logged From:** TelemetryLoggerMiddleware (**Enterprise Sample**)

Logged when bot receives new message.

- UserID  ([From Telemetry Initializer](https://aka.ms/telemetry-initializer))
- ConversationID ([From Telemetry Initializer](https://aka.ms/telemetry-initializer))
- ActivityID  ([From Telemetry Initializer](https://aka.ms/telemetry-initializer))
- Channel  ([From Telemetry Initializer](https://aka.ms/telemetry-initializer))
- ActivityType  ([From Telemetry Initializer](https://aka.ms/telemetry-initializer))
- Text (Optional for PII)
- FromId
- FromName
- RecipientId
- RecipientName
- ConversationId
- ConversationName
- Locale

### CustomEvent: BotMessageSend 
**Logged From:** TelemetryLoggerMiddleware (**Enterprise Sample**)

Logged when bot sends a message.

- UserID  ([From Telemetry Initializer](https://aka.ms/telemetry-initializer))
- ConversationID ([From Telemetry Initializer](https://aka.ms/telemetry-initializer))
- ActivityID  ([From Telemetry Initializer](https://aka.ms/telemetry-initializer))
- Channel  ([From Telemetry Initializer](https://aka.ms/telemetry-initializer))
- ActivityType  ([From Telemetry Initializer](https://aka.ms/telemetry-initializer))
- ReplyToID
- Channel  (Source channel - e.g. Skype, Cortana, Teams)
- RecipientId
- ConversationName
- Locale
- Text (Optional for PII)
- RecipientName (Optional for PII)

### CustomEvent: BotMessageUpdate
**Logged From:** TelemetryLoggerMiddleware
Logged when a message is updated by the bot (rare case)

### CustomEvent: BotMessageDelete
**Logged From:** TelemetryLoggerMiddleware
Logged when a message is deleted by the bot (rare case)

### CustomEvent: LuisIntent.INENTName 
**Logged From:** TelemetryLuisRecognizer (**Enterprise Sample**)

Logs results from LUIS service.

- UserID  ([From Telemetry Initializer](https://aka.ms/telemetry-initializer))
- ConversationID ([From Telemetry Initializer](https://aka.ms/telemetry-initializer))
- ActivityID  ([From Telemetry Initializer](https://aka.ms/telemetry-initializer))
- Channel  ([From Telemetry Initializer](https://aka.ms/telemetry-initializer))
- ActivityType  ([From Telemetry Initializer](https://aka.ms/telemetry-initializer))
- Intent
- IntentScore
- Question
- ConversationId
- SentimentLabel
- SentimentScore
- *LUIS entities*
- **NEW** DialogId

### CustomEvent: QnAMessage
**Logged From:** TelemetryQnaMaker (**Enterprise Sample**)

Logs results from QnA Maker service.

- UserID  ([From Telemetry Initializer](https://aka.ms/telemetry-initializer))
- ConversationID ([From Telemetry Initializer](https://aka.ms/telemetry-initializer))
- ActivityID  ([From Telemetry Initializer](https://aka.ms/telemetry-initializer))
- Channel  ([From Telemetry Initializer](https://aka.ms/telemetry-initializer))
- ActivityType  ([From Telemetry Initializer](https://aka.ms/telemetry-initializer))
- Username
- ConversationId
- OriginalQuestion
- Question
- Answer
- Score (*Optional*: if we found knowledge)

## Querying the data
When using Application Insights, all the data is correlated together (even across services).  We can see by querying a successful request and see all the associated events for that request.  
The following queries will tell you the most recent requests:
```sql
requests 
| where timestamp > ago(3d) 
| where resultCode == 200
| order by timestamp desc
| project timestamp, operation_Id, appName
| limit 10
```

From the first query, select a few `operation_Id`'s and then look for more information:

```sql
let my_operation_id = "<OPERATION_ID>";
let union_all = () {
    union
    (traces | where operation_Id == my_operation_id),
    (customEvents | where operation_Id == my_operation_id),
    (requests | where operation_Id == my_operation_id),
    (dependencies | where operation_Id  == my_operation_id),
    (exceptions | where operation_Id == my_operation_id)
};
union_all
    | order by timestamp asc
    | project itemType, name, performanceBucket
```

This will give you the chronological breakdown of a single request, with the duration bucket of each call.
![Example Call](media/performance_query.png)

> Note: The "Activity" `customEvent` event timestamp is out of order, since these events are logged asynchronously.

## Create a dashboard

The easiest way to test is by creating a dashboard using [Azure portal's template deployment page](https://portal.azure.com/#create/Microsoft.Template).  
- Click ["Build your own template in the editor"]
- Copy and paste either one of these .json file that is provided to help you create the dashboard:
  - [System Health Dashboard](https://aka.ms/system-health-appinsights)
  - [Conversation Health Dashboard](https://aka.ms/conversation-health-appinsights)
- Click "Save"
- Populate `Basics`: 
   - Subscription: <your test subscription>
   - Resource group: <a test resource group>
   - Location: <such as West US>
- Populate `Settings`:
   - Insights Component Name: <like `core672so2hw`>
   - Insights Component Resource Group: <like `core67`>
   - Dashboard Name:  <like `'ConversationHealth'` or `SystemHealth`>
- Click `I agree to the terms and conditions stated above`
- Click `Purchase`
- Validate
   - Click on [`Resource Groups`](https://ms.portal.azure.com/#blade/HubsExtension/Resources/resourceType/Microsoft.Resources%2Fsubscriptions%2FresourceGroups)
   - Select your Resource Group from above (like `core67`).
   - If you don't see a new Resource, then look at "Deployments" and see if any have failed.
   - Here's what you typically see for failures:
     
```json
{"code":"DeploymentFailed","message":"At least one resource deployment operation failed. Please list deployment operations for details. Please see https://aka.ms/arm-debug for usage details.","details":[{"code":"BadRequest","message":"{\r\n \"error\": {\r\n \"code\": \"InvalidTemplate\",\r\n \"message\": \"Unable to process template language expressions for resource '/subscriptions/45d8a30e-3363-4e0e-849a-4bb0bbf71a7b/resourceGroups/core67/providers/Microsoft.Portal/dashboards/Bot Analytics Dashboard' at line '34' and column '9'. 'The template parameter 'virtualMachineName' is not found. Please see https://aka.ms/arm-template/#parameters for usage details.'\"\r\n }\r\n}"}]}
```

To view the data, go to the Azure portal. Click **Dashboard** on the left, then select the dashboard you created from the drop-down.

## Additional resources
You can refer to these samples that implement telemetry:
- C#
  - [LUIS with AppInsights](https://aka.ms/luis-with-appinsights-cs)
  - [QnA with AppInsights](https://aka.ms/qna-with-appinsights-cs)
- JS
  - [LUIS with AppInsights](https://aka.ms/luis-with-appinsights-js)
  - [QnA with AppInsights](https://aka.ms/qna-with-appinsights-js)

